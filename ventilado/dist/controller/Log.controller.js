sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(t,e,o,a,n,r,s){"use strict";var i=this;var c;var d;var l;var u;return t.extend("ventilado.ventilado.controller.Log",{onInit:async function(){this._dbConnections=[];var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("Log").attachMatched(this.onRouteMatched,this);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this));await this.ejecutarAcciones()},onRouteMatched:function(){this.ejecutarAcciones()},ejecutarAcciones:async function(){c=localStorage.getItem("sPuesto");l=localStorage.getItem("sReparto");u=localStorage.getItem("sPtoPlanif");d=localStorage.getItem("sPreparador");await this.obtenerYProcesarDatos();this.datosD.sort(function(t,e){if(t.IdScan<e.IdScan){return-1}if(t.IdScan>e.IdScan){return 1}return 0});const t=this.datosD.reduce((t,e)=>t+(e.cantidadAsig||0),0);var e=new o({tableData:this.datosD,totalCantidadAsig:t,Transporte:this.datosD[0].Transporte});this.getView().setModel(e)},obtenerYProcesarDatos:async function(){try{let t=await this.obtenerDatosDeIndexedDB();this.datosD=this.procesarDatos(t)}catch(t){console.log("Error:",t)}},obtenerDatosDeIndexedDB:function(){i=this;return new Promise((t,e)=>{let o=indexedDB.open("ventilado",5);o.onerror=t=>{console.log("Error al abrir la base de datos:",t);e("Error al abrir la base de datos")};o.onsuccess=e=>{let o=e.target.result;i._dbConnections.push(o);let a=o.transaction(["ventilado"],"readonly");let n=a.objectStore("ventilado");let r=[];n.openCursor().onsuccess=e=>{let o=e.target.result;if(o){r.push(o.value);o.continue()}else{t(r)}}}})},procesarDatos:function(t){let e={};t.forEach(t=>{if(t.CantEscaneada>0){e[t.Id]={Id:t.Id,IdScan:t.AdicChar2,Ean:t.Ean,CodigoInterno:t.CodigoInterno,Descricion:t.Descricion,RutaAsig:String(t.LugarPDisp).padStart(2,"0"),RutaConf:String(t.LugarPDisp).padStart(2,"0"),Transporte:t.Transporte,Entrega:t.Entrega,EntreProd:t.Entrega+t.CodigoInterno,Asign:t.Entrega+t.CodigoInterno+"A",TipoLog:"SCAN",FechaHora:t.AdicDec2,Preparador:t.Preparador,Cliente:t.Destinatario,cantidadAsig:t.CantEscaneada}}});let o=Object.keys(e).map(t=>e[t]);return o},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(t=>{t.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()}})});
//# sourceMappingURL=Log.controller.js.map