sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(t,e,o,a,n,r,s){"use strict";var i=this;var d;var l;var c;var u;var h;var p;var f=[];return t.extend("ventilado.ventilado.controller.Desconsolidado",{formatCantidadTotal:function(t){return t===0?"":t},formatRuta:function(t,e){return t===0?"":e},onInit:async function(){this._dbConnections=[];var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("Desconsolidado").attachMatched(this.onRouteMatched,this);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this));await this.ejecutarAcciones()},onRouteMatched:function(){this.ejecutarAcciones()},ejecutarAcciones:async function(){l=localStorage.getItem("sPuesto");c=localStorage.getItem("sReparto");u=localStorage.getItem("sPtoPlanif");h=localStorage.getItem("sPreparador");await this.obtenerYProcesarDatos();var t={};var e={};f.forEach(function(o){var a=o.CodInterno;var n=o.Descripcion;var r=o.Ruta;var s=o.CantidadEscaneada;var i=o.Entrega;var d=o.Transporte;if(!t[a]){t[a]={CodInterno:a,Descripcion:n,Transporte:d,Entrega:i}}t[a][r]=s;if(!e[r]){e[r]={CantidadTotal:0,Entrega:i}}e[r].CantidadTotal+=s});var o=[];for(var a in t){o.push(t[a])}console.log(o);var n=[];for(var r in e){n.push({Ruta:r,CantidadTotal:e[r].CantidadTotal,Entrega:e[r].Entrega})}var s=[];for(var i=1;i<=30;i++){s.push(String(i).padStart(2,"0"))}s.forEach(function(t){if(!n.some(function(e){return e.Ruta===t})){n.push({Ruta:t,CantidadTotal:0,Entrega:null})}});n.sort(function(t,e){if(t.Ruta<e.Ruta){return-1}if(t.Ruta>e.Ruta){return 1}return 0});console.log(n);var d=new sap.ui.model.json.JSONModel;d.setData({tableData:o,totalesPorRuta:n});this.getView().setModel(d);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this))},obtenerYProcesarDatos:async function(){try{let t=await this.obtenerDatosDeIndexedDB();f=this.procesarDatos(t)}catch(t){console.log("Error:",t)}},obtenerDatosDeIndexedDB:function(){i=this;return new Promise((t,e)=>{let o=indexedDB.open("ventilado",5);o.onerror=t=>{console.log("Error al abrir la base de datos:",t);e("Error al abrir la base de datos")};o.onsuccess=e=>{let o=e.target.result;i._dbConnections.push(o);let a=o.transaction(["ventilado"],"readonly");let n=a.objectStore("ventilado");let r=[];n.openCursor().onsuccess=e=>{let o=e.target.result;if(o){r.push(o.value);o.continue()}else{t(r)}}}})},procesarDatos:function(t){t.sort(function(t,e){if(t.CodInterno<e.CodInterno){return-1}if(t.CodInterno>e.CodInterno){return 1}return 0});let e={};t.forEach(t=>{e[t.Id]={Id:t.Id,CodInterno:t.CodigoInterno,Descripcion:t.Descricion,CantidadEscaneada:t.CantEscaneada,Ruta:String(t.LugarPDisp).padStart(2,"0"),Transporte:t.Transporte,Entrega:t.Entrega}});let o=Object.keys(e).map(t=>e[t]);return o},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(t=>{t.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()}})});
//# sourceMappingURL=Desconsolidado.controller.js.map