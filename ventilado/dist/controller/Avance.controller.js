sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(t,e,o,a,n,r,s){"use strict";var i=this;var c;var l;var d;var u;var h;var p;var C=[];return t.extend("ventilado.ventilado.controller.Desconsolidado",{onInit:async function(){this._dbConnections=[];var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("Avance").attachMatched(this.onRouteMatched,this);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this));await this.ejecutarAcciones()},onRouteMatched:function(){this.ejecutarAcciones()},ejecutarAcciones:async function(){l=localStorage.getItem("sPuesto");d=localStorage.getItem("sReparto");u=localStorage.getItem("sPtoPlanif");h=localStorage.getItem("sPreparador");await this.obtenerYProcesarDatos();const t=this.datosD.reduce((t,e)=>t+(e.cantidadAsig||0),0);var e=new o({tableData:this.datosD,tableData2:this.datosD2,totalCantidadAsig:t});this.getView().setModel(e)},obtenerYProcesarDatos:async function(){try{let t=await this.obtenerDatosDeIndexedDB();this.datosD=this.procesarDatos(t);this.datosD2=this.procesarDatos2(t)}catch(t){console.log("Error:",t)}},obtenerDatosDeIndexedDB:function(){i=this;return new Promise((t,e)=>{let o=indexedDB.open("ventilado",5);o.onerror=t=>{console.log("Error al abrir la base de datos:",t);e("Error al abrir la base de datos")};o.onsuccess=e=>{let o=e.target.result;i._dbConnections.push(o);let a=o.transaction(["ventilado"],"readonly");let n=a.objectStore("ventilado");let r=[];n.openCursor().onsuccess=e=>{let o=e.target.result;if(o){r.push(o.value);o.continue()}else{t(r)}}}})},procesarDatos:function(t){t.sort(function(t,e){if(t.Ruta<e.Ruta){return-1}if(t.Ruta>e.Ruta){return 1}return 0});let e={};t.forEach(t=>{let o=t.LugarPDisp;let a=t.CantidadEntrega;let n=t.CantEscaneada;if(!e[o]){e[t.LugarPDisp]={Ruta:o,TOT:0,SCAN:0,FALTA:0,"Cub TEO":t.Cubteo,TRANSPORTE:t.Transporte,ENTREGA:t.Entrega,KILO:0,M3:t.M3teo,CLIENTE:t.Destinatario}}e[o]["TOT"]+=a;e[o]["SCAN"]+=Number(n)||0;e[o]["FALTA"]=e[o]["TOT"]-e[o]["SCAN"];e[o]["KILO"]+=parseFloat(t.kgbrr)||0;e[o]["M3"]=parseFloat(t.M3r)||0;e[o]["CLIENTE"]=t.Destinatario});let o=Object.keys(e).map(t=>e[t]);return o},procesarDatos2:function(t){t.sort(function(t,e){if(t.Ruta<e.CodigoInterno){return-1}if(t.Ruta>e.CodigoInterno){return 1}return 0});let e={};t.forEach(t=>{let o=t.CodigoInterno;let a=t.CantidadEntrega;let n=t.CantEscaneada;if(!e[o]){e[o]={CI:o,TOT:0,SCAN:0,FALTA:0,TRANSPORTE:t.Transporte,ENTREGA:t.Entrega,DESCRIPCION:t.Descricion}}e[o]["TOT"]+=a;e[o]["SCAN"]+=Number(n);e[o]["FALTA"]=e[o]["TOT"]-e[o]["SCAN"]});let o=Object.keys(e).map(t=>e[t]);return o},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(t=>{t.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()}})});
//# sourceMappingURL=Avance.controller.js.map