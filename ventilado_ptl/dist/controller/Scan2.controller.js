sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/PDFViewer","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(e,t,o,r,a,n,i,s,c){"use strict";var l=this;var d;var u;var g;var p;var v;var f;var h=0;return e.extend("ventilado.ventilado.controller.Scan2",{onInit:async function(){this._dbConnections=[];var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("Log").attachMatched(this.onRouteMatched,this);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this));await this.ejecutarAcciones();h=await this.obtenerMaxAdicChar2()},onRouteMatched:function(){this.ejecutarAcciones()},ejecutarAcciones:async function(){u=localStorage.getItem("sPuesto");g=localStorage.getItem("sReparto");p=localStorage.getItem("sPtoPlanif");v=localStorage.getItem("sPreparador");g=g.padStart(10,"0");p=p.padStart(4,"0");this._checkNetworkStatus();this._fetchCodConfirmacionData();var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e);this.obtenerYProcesarDatos()},obtenerMaxAdicChar2:async function(){let e=await this.obtenerDatosDeIndexedDB();let t=0;e.forEach(e=>{let o=parseInt(e.AdicChar2,10);if(!isNaN(o)&&o>t){t=o}});return t},obtenerYProcesarDatos:async function(){try{let s=await this.obtenerDatosDeIndexedDB();let c=this.procesarDatos(s);var e=c.reduce(function(e,t){return e+Number(t.TOT)},0);var t=c.reduce(function(e,t){return e+Number(t.SCAN)},0);var o=c.reduce(function(e,t){return e+Number(t.FALTA)},0);var r=c.reduce(function(e,t){return e+Number(t["Cub TEO"])},0);var a=["Ruta","CLIENTE","RAZONSOCIAL","TOT","SCAN","FALTA","Cub TEO","C Real","Pa"];var n=c.map(e=>{var t={};a.forEach(o=>{t[o]=e[o]||"0"});return t});var i=this.getView().getModel();i.setData({printEtiquetas:false,isStarted:false,isArrowVisible:false,isClosed:true,showPasswordInput:false,tableData:n,totalP:e,totalScan:t,totalFalta:o,totalCubTeo:r,estadoDelTransporte:"",puesto:"Estación de trabajo Nro: "+u,transporte:"Reparto: "+String(Number(g)),cuenta:0,cantidad:0,ruta:0,ean:"",eanRuta:"",id:0});this.getView().setModel(i);console.log(n)}catch(e){console.log("Error:",e)}},obtenerDatosDeIndexedDB:function(){var e=this;return new Promise((t,o)=>{let r=indexedDB.open("ventilado",5);r.onerror=e=>{console.log("Error al abrir la base de datos:",e);o("Error al abrir la base de datos")};r.onsuccess=o=>{let r=o.target.result;e._dbConnections.push(r);let a=r.transaction(["ventilado"],"readonly");let n=a.objectStore("ventilado");let i=[];n.openCursor().onsuccess=e=>{let o=e.target.result;if(o){i.push(o.value);o.continue()}else{t(i)}}}})},procesarDatos:function(e){let t={};e.forEach(e=>{let o=e.LugarPDisp;let r=e.CantidadEntrega;let a=e.CantEscaneada;if(!t[o]){t[o]={Ruta:o,TOT:0,SCAN:0,FALTA:0,"Cub TEO":e.Cubteo,"C Real":0,Pa:0,TRANSPORTE:e.Transporte,ENTREGA:e.Entrega,CUBETA:0,PRODUCTO:0,KILO:0,M3:e.M3teo,CLIENTE:e.Destinatario,RAZONSOCIAL:e.NombreDestinatario,DIRECCION:e.Calle,LOCALIDAD:e.LugarDestinatario,CODIGOINTERNO:e.CodigoInterno}}t[o]["TOT"]+=r;t[o]["SCAN"]+=Number(a);t[o]["FALTA"]=t[o]["TOT"]-t[o]["SCAN"];t[o]["CUBETA"]="";t[o]["TOTALCUBETA"]=t[o]["TOTALCUBETA"];t[o]["PRODUCTO"]=t[o]["TOT"];t[o]["KILO"]+=e.kgbrr;t[o]["M3"]=e.M3r;t[o]["CLIENTE"]=e.Destinatario;t[o]["RAZONSOCIAL"]=e.NombreDestinatario;t[o]["DIRECCION"]=e.Calle;t[o]["LOCALIDAD"]=e.LugarDestinatario;t[o]["C Real"]=e.Cubre;t[o]["Pa"]=e.Pa;t[o]["Cub TEO"]+=e.Cubteo});let o=Object.keys(t).map(e=>t[e]);return o},_checkNetworkStatus:function(){if(navigator.onLine){t.show("Conexión a internet disponible.")}else{t.show("No hay conexión a internet.")}},_updateNetworkStatus:function(){this._checkNetworkStatus()},onClearEanInput:function(){var e=this.getView().getModel();var t=this.getView().byId("txtCantidad");var o=this.getView().byId("txtRuta");var r=this.getView().byId("lDescripcion");var a=this.getView().byId("eanInput");var n=this.getView().byId("edtCI");e.setProperty("/ruta",0);e.setProperty("/cantidad",0);e.setProperty("/ean","");e.setProperty("/id",0);e.setProperty("/isArrowVisible",false);t.setText("");o.setText("");r.setText("");a.setValue("");n.setText("")},onStartPress:function(){var e=this.getView().getModel();e.setProperty("/isStarted",true);var t=this.getView().byId("eanInput");setTimeout(function(){t.focus()},0);l=this.getView();document.body.addEventListener("click",function(e){var t=l.byId("eanInput");t.focus()})},onEanInputSubmit:function(e){var t=e.getSource();var o=t.getValue();this.handleEanEnter(o)},handleEanEnter:async function(e){l=this;var o=this.getView().byId("txtCantidad");var r=this.getView().byId("txtRuta");var a=this.getView().byId("lDescripcion");var n=this.getView().byId("eanInput");var i=this.getView().byId("edtCI");var s=this.getView().getModel();var d;if(s.getProperty("/ruta")==0){try{d=await this.obtenerCantidadYRuta(e,1);if(d.cantidad>0){console.log("es un producto");s.setProperty("/ruta",d.ruta);s.setProperty("/cantidad",d.cantidad);s.setProperty("/ean",e);s.setProperty("/id",d.id);s.setProperty("/AdicChar2",d.AdicChar2);o.setText(d.cantidad);r.setText(d.ruta);a.setText(d.descripcion);n.setValue(d.ean);i.setText(d.ci)}else{d=await this.obtenerCantidadYRuta(e,2);if(d.cantidad>0){console.log("es un ci");s.setProperty("/ruta",d.ruta);s.setProperty("/cantidad",d.cantidad);s.setProperty("/ean",d.ean);s.setProperty("/id",d.id);s.setProperty("/ci",d.ci);o.setText(d.cantidad);r.setText(d.ruta);a.setText(d.descripcion);n.setValue(d.ean);i.setText(d.ci)}else{if(d.cantidad==-2){console.log(" Error: Producto sobrante");c.error("ERROR. este producto no puede asignarse a ninguna ruta. Producto sobrante",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}else if(d.cantidad==-1){console.log(" Error no se conoce el valor ingresado");c.error("ERROR. No se pudo determinar el valor ingresado",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}}}}catch(e){console.error("Error al obtener la cantidad y la ruta:",e)}}else{var u=this._findRouteByEAN(e);if(u){console.log("es una confirmacion");var g=s.getProperty("/cantidad");if(u==s.getProperty("/ruta")){s.setProperty("/ruta",0);s.setProperty("/cantidad",0);s.setProperty("/ean","");s.setProperty("/ci","");s.setProperty("/descripcion","");var p=indexedDB.open("ventilado",5);var v=s.getProperty("/id");p.onsuccess=function(e){var t=e.target.result;l._dbConnections.push(t);h=h+1;l.actualizarEstado(t,v,"Completo",g,String(h),l.getFormattedDateTime())};s.setProperty("/id",0);o.setText("");r.setText("");a.setText("");n.setValue("");i.setText("");var f=s.getProperty("/tableData");f.forEach(function(e){if(e.Ruta===u){e.SCAN=Number(e.SCAN)||0;e.SCAN+=Number(g);e.FALTA=e.FALTA-Number(g)}});var C=s.getProperty("/totalScan");C=C+Number(g);var E=s.getProperty("/totalFalta");E=E-Number(g);s.setProperty("/tableData",f);s.setProperty("/totalScan",C);s.setProperty("/totalFalta",E)}else{c.error("Error : Esta confirmando en una ruta equivocada, tiene que hacelo en la ruta "+s.getProperty("/ruta"),{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}}else{c.error("Error : Tiene que ingresar un codigo de confirmacion de ruta",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}}var s=this.getView().getModel();s.setProperty("/isArrowVisible",true);var a=this.getView().byId("lDescripcion");t.show("Valor ingresado: "+e)},_findRouteByEAN:function(e){var t=this.getView().getModel();var o=t.getProperty("/codConfirmacionData");var r=o.find(function(t){return t.Ean===e});if(r){return r.Ruta}else{console.log("EAN no encontrado.");return null}},_fetchCodConfirmacionData:function(){var e=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZVENTILADO_SRV/");e.read("/CodConfirmacionSet",{success:function(e){var t=this.getView().getModel();if(Array.isArray(e.results)){t.setProperty("/codConfirmacionData",e.results)}else{var o=e.results;t.setProperty("/codConfirmacionData",[o])}console.log("Datos copiados con éxito.")}.bind(this),error:function(e){console.error("Error al leer datos del servicio OData:",e)}})},actualizarEstado:function(e,t,o,r,a,n){l=this;var i=e.transaction(["ventilado"],"readwrite");var s=i.objectStore("ventilado");var c=s.get(t);c.onsuccess=function(e){var i=e.target.result;if(i){i.Estado=o;i.CantEscaneada=r;i.AdicChar2=a;i.AdicDec2=n;i.Preparador=v;i.AdicDec1=u;var c=s.put(i);c.onsuccess=function(e){console.log("El campo 'Estado' ha sido actualizado exitosamente.");var i=s.get(t);i.onsuccess=function(e){var i=e.target.result;console.log("Valor actualizado del campo 'Estado':",i.Estado);l.oActualizarBackEnd(t,o,r,a,n,v,u)};i.onerror=function(e){console.log("Error al verificar el campo 'Estado':",e.target.error)}};c.onerror=function(e){console.log("Error al actualizar el campo 'Estado':",e.target.error)}}else{console.log("No se encontró ningún registro con el Id proporcionado.")}}},oActualizarBackEnd:function(e,t,o,r,a,n,i){var s=[{Id:e,Estado:t,CantEscaneada:o,AdicChar2:r,AdicDec2:a,Preparador:n,AdicDec1:i}];this.crud("ACTUALIZAR","ventilado",e,s,"")},obtenerCantidadYRuta:async function(e,t){try{var o=await this.onGetData(e,t);return{cantidad:o.Cantidad,ruta:o.Ruta,descripcion:o.descripcion,id:o.id,ean:o.ean,ci:o.ci,AdicChar2:o.AdicChar2}}catch(e){return{cantidad:-3,ruta:-1,descripcion:""}}},onCierrePress:function(){},onGeneratePDF:function(){var e=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZVENTILADO_SRV/",{useBatch:false});l=this.getView();var t=e.sServiceUrl;var o=t+"/sFormSet(Fname='"+g+"')/$value";var r=new sap.m.PDFViewer;l.addDependent(r);r.setSource(o);r.setTitle("Etiquetas del Reparto");r.open()},onGeneratePDF_back:function(){var e=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZVENTILADO_SRV/",{useBatch:false});var t={Dni:1,Nombre:"value2",Apellido:"erere"};l=this.getView();e.create("/zpruebaSet",t,{success:function(t,o){var r=e.sServiceUrl;var a=r+"/sFormSet(Fname='"+d+"')/$value";var n=new sap.m.PDFViewer;l.addDependent(n);n.setSource(a);n.setTitle("Etiquetas del Reparto");n.open()}.bind(this),error:function(e){sap.m.MessageToast.show("Error al enviar datos al backend")}})},onOpenTransport:function(){var e=this.getView().getModel();e.setProperty("/showPasswordInput",true)},onPasswordSubmit:function(){var e=this.getView().getModel();var o=this.getView().byId("password").getValue();if(o==="12345"){var r=e.setProperty("/tableData2");console.log("Updated Data: ",e.getProperty("/tableData"));var a=indexedDB.open("ventilado",5);a.onsuccess=function(t){var o=t.target.result;l._dbConnections.push(o);r.forEach(function(t){l.actualizarCantCubReales(o,indice,nuevoCubR,nuevoValorPa,"");l.byId("dialogoStop").close();var r=l.getView().getModel();e.setProperty("/estadoDelTransporte","");e.setProperty("/isClosed",true);e.setProperty("/showPasswordInput",false);e.setProperty("/printEtiquetas",true)})};e.setProperty("/isClosed",false);e.setProperty("/showPasswordInput",false);t.show("Transporte abierto con éxito.")}else{c.error("Error :Contraseña incorrecta. Por favor, inténtelo de nuevo.",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}},onOpenCodeInputDialog:function(){var e=this.getView();if(!this.byId("dialogoCI")){r.load({id:e.getId(),name:"ventilado.ventilado.view.CodeInputDialog",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("dialogoCI").open()}},onCodeInputConfirm:async function(){var e=this.byId("codeInput");var t=e.getValue();var o=this.getView().byId("edtCI");o.setText(t);this.byId("dialogoCI").close();var r=await this.onGetData2(t);var a=this.byId("eanInput");a.setValue(r.ean);this.handleEanEnter(r.ean)},onCodeInputDialogClose:function(e){var t=this.byId("codeInput");t.setValue("");var o=this.byId("eanInput");o.focus()},onPessParcialDialog:function(){var e=this.getView();if(!this.byId("parcial")){r.load({id:e.getId(),name:"ventilado.ventilado.view.ParcialDialog",controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("dialogoParcial").open()}},onParcialConfirm:function(){var e=this.byId("parcial");var t=e.getValue();this.byId("dialogoParcial").close()},onParcialDialogClose:function(e){var t=this.byId("parcial");t.setValue("");var o=this.byId("eanInput");o.focus()},onStopDialog:function(){l=this;var e=this.getView().getModel();var t=this.getView();if(!this.byId("dialogoStop")){r.load({id:t.getId(),name:"ventilado.ventilado.view.StopDialog",controller:this}).then(function(e){t.addDependent(e);e.open()})}else{this.byId("dialogoStop").open()}},onStopConfirm:function(){var e=this.byId("customTable2");var t=e.getItems();var o=this.getView().getModel();var r=o.getProperty("/tableData");var a=true;t.forEach(function(e,t){var o=e.getCells();if(o[7].getValue()<=0&&o[8].getValue()<=0){a=false}r[t]["C Real"]=o[7].getValue();r[t]["Pa"]=o[8].getValue()});if(a){o.setProperty("/tableData",r);console.log("Updated Data: ",o.getProperty("/tableData"));var n=indexedDB.open("ventilado",5);var i=o.getProperty("/id");n.onsuccess=function(e){var t=e.target.result;l._dbConnections.push(t);r.forEach(function(e){var o=e.Ruta;var r=Number(e["C Real"]);var a=Number(e["Pa"]);l.actualizarCantCubReales(t,o,r,a,"CERRADO");l.byId("dialogoStop").close();var n=l.getView().getModel();n.setProperty("/estadoDelTransporte","CERRADO");n.setProperty("/isClosed",true);n.setProperty("/showPasswordInput",false);n.setProperty("/printEtiquetas",true)})}}else{c.error("Los campos 'C Real' y 'Pa' no pueden ser ambos cero. Por favor, introduce valores válidos.",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}},actualizarCantCubReales:function(e,t,o,r,a){l=this;var n=e.transaction(["ventilado"],"readwrite");var i=n.objectStore("ventilado");var s=i.index("LugarPDisp");var c=t;s.openCursor(IDBKeyRange.only(c)).onsuccess=function(e){var t=e.target.result;if(t){var n=t.value;n.Cubre=o;n.Pa=r;n.AdicChar1=a;var i=n.Id;var s=t.update(n);s.onsuccess=function(){console.log("Registro actualizado:",n);var e=[{Id:i,Cubre:o,Pa:r,AdicChar1:a}];l.crud("ACTUALIZAR","ventilado",i,e,"")};s.onerror=function(e){console.error("Error al actualizar el registro:",e.target.errorCode)};t.continue()}else{console.log("No more records found or no records found")}};n.oncomplete=function(){console.log("Transacción completada.")};n.onerror=function(e){console.error("Error en la transacción:",e.target.errorCode)}},onStopDialogClose:function(e){},crud:function(e,o,r,a,n){var c=this;var l=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZVENTILADO_SRV/",{useBatch:false,defaultBindingMode:"TwoWay",deferredGroups:["batchGroup1"]});l.refreshMetadata();var d="/"+o+"Set";if(e=="READ"){var u=[];u.push(new i("Transporte",s.EQ,a));u.push(new i("Entrega",s.EQ,n));l.read(d,{filters:u,success:function(e){console.log(e)},error:function(e){console.error(e)}})}else if(e=="FI"){var v=g;var f=p;l.callFunction("/GenerarTransporte",{method:"GET",urlParameters:{transporte:v,pto_planificacion:f},success:function(e){t.show("Se cargaron los datos para el ventilado");var o=e.Transporte;var r=e.Entrega;var a=e.Pto_planificacion;var n=e.Ean;console.log("Transporte: ",o);console.log("Pto Entrega: ",a);console.log("Entrega: ",r);console.log("Estado: ",n);c.crud("READ","ventilado",o,"1700")},error:function(e){var o="";try{var r=JSON.parse(e.responseText);o=r.error.message.value}catch(e){o="Error desconocido"}t.show(o)}})}else if(e=="CREAR"){var h=function(e,r,a){var n="/"+o+"Set";l.create(n,e,{success:function(){if(r)r()},error:function(o){t.show("Error al crear el registro "+e.Dni);console.error(o);if(a)a(o)}})};var C=function(e){if(e<a.length){h(a[e],function(){C(e+1)})}else{t.show("Todos los registros se han creado con éxito.")}}.bind(this);C(0)}else if(e=="ACTUALIZAR"){var E=function(e,r,a){var n="/"+o+"Set";var i=n+"("+e.Id+")";l.update(i,e,{success:function(){t.show("Registro "+e.Id+" actualizado con éxito.");if(r)r()},error:function(o){t.show("Error al actualizar el registro "+e.Dni);console.error(o);if(a)a(o)}})};var b=function(e){var o=function(r){if(r<e.length){E(e[r],function(){o(r+1)})}else{t.show("Todos los registros se han actualizado con éxito.")}}.bind(this);o(0)};b(a)}else if(e=="BORRAR"){var m=function(){console.log("Operación exitosa")};var y=function(e){console.error("Error:",e)};var D=function(e,o,a,n){var i="/zpruebaSet("+r+")";l.remove(i,{success:function(){t.show("Registro "+r+" eliminado con éxito.");if(o)o()},error:function(o){t.show("Error al eliminar el registro "+e);console.error(o);if(a)a(o)}});console.log("Additional Parameter:",n)};var w=3;D(w,m,y,"additionalParameter")}},_fetchAndStoreOData:function(){var e=new n("/sap/opu/odata/sap/ZVENTILADO_SRV/");e.read("/ventiladoSet",{success:function(e){var t=this.db.transaction(["ventilado"],"readwrite");var o=t.objectStore("ventilado");e.results.forEach(function(e){o.put(e)});console.log("Datos copiados con éxito.")}.bind(this),error:function(e){console.error("Error al leer datos del servicio OData:",e)}})},onGetData:function(e,t){l=this;var o;var r=e;var a=0;return new Promise(function(e,n){var i;var s=indexedDB.open("ventilado",5);s.onsuccess=function(n){var s=n.target.result;l._dbConnections.push(s);var c=s.transaction(["ventilado"],"readonly");var d=c.objectStore("ventilado");if(t==1){if(!d.indexNames.contains("Ean")){console.error("El índice 'Ean' no se encontró.");return}i=d.index("Ean")}else{if(!d.indexNames.contains("CodigoInterno")){console.error("El índice 'CodigoInterno' no se encontró.");return}i=d.index("CodigoInterno")}var u=i.openCursor(IDBKeyRange.only(r));u.onsuccess=function(r){var n=r.target.result;if(n){var i=n.value;if(i.Estado!="Completo"){console.log("Registro encontrado:",i);var s=i.Id;var c=i.Descricion;var l=i.CantidadEntrega;var d=i.Ean;var u=i.CodigoInterno;var g=i.AdicChar2;var p=i.LugarPDisp;o={Cantidad:l,Ruta:p,descripcion:c,id:s,ean:d,ci:u,AdicChar2:g};a=2;e(o)}else{a=1;n.continue();return}}if(a<2){if(a==1&&(t==1||t==2)){o={Cantidad:-2,Ruta:0,descripcion:"",id:0};e(o)}else if(a==0&&t==1){o={Cantidad:-1,Ruta:0,descripcion:"",id:0};e(o)}else if(a==0&&t==2){o={Cantidad:-1,Ruta:0,descripcion:"",id:0};e(o)}}};u.onerror=function(e){console.log("Error al buscar el registro:",e.target.error)}};s.onerror=function(e){console.log("Error al abrir la base de datos:",e.target.error)}}.bind(this))},onOpenDialog:function(e,t,o){var a=this.getView();if(!this.byId("codeDialog")){r.load({id:a.getId(),name:"ventilado.ventilado.view.CodeDialog",controller:this}).then(function(r){a.addDependent(r);r.open();var n=r.getContent()[0].getItems();if(n&&n.length>=3){n[0].setText(e);n[1].setText(t);n[2].setText(o)}})}else{var n=this.byId("codeDialog");var i=n.getContent()[0].getItems();if(i&&i.length>=3){i[0].setText(e);i[1].setText(t);i[2].setText(o)}n.open()}},onCodeConfirm:async function(){this.byId("codeDialog").close()},onCodeInputDialogClose:function(e){var t=this.byId("eanInput");t.focus()},onDeleteData:function(){var e=this.db.transaction(["ventilado"],"readwrite");var t=e.objectStore("ventilado");var o=t.delete("1234567890");o.onsuccess=function(e){console.log("Dato eliminado con éxito.")};o.onerror=function(e){console.error("Error al eliminar el dato:",e.target.errorCode)}},manejarCRUD:function(e,t,o="id"){return new Promise((r,a)=>{const n=indexedDB.open("ventilado",5);n.onupgradeneeded=function(e){const t=e.target.result;l._dbConnections.push(t);if(!t.objectStoreNames.contains("ventilado")){const e=t.createObjectStore("ventilado",{keyPath:"id"});e.createIndex("nombre","nombre",{unique:false})}};n.onsuccess=function(n){const i=n.target.result;const s=i.transaction(["ventilado"],"readwrite");const c=s.objectStore("ventilado");let l;switch(e){case"crear":l=c.add(t);break;case"leer":l=o==="id"?c.get(t.id):c.index(o).get(t[o]);break;case"actualizar":if(o==="id"){l=c.put(t)}else{const n=c.index(o).get(t[o]);n.onsuccess=function(o){const n=o.target.result;if(n){Object.assign(n,t);const o=c.put(n);o.onsuccess=()=>r(o.result);o.onerror=t=>a(new Error(`Error en la operación ${e}: ${t.target.error}`))}else{a(new Error("Elemento no encontrado para actualizar"))}};n.onerror=e=>a(new Error(`Error al buscar para actualizar: ${e.target.error}`));return}break;case"eliminar":if(o==="id"){l=c.delete(t.id)}else{const n=c.index(o).getKey(t[o]);n.onsuccess=function(t){const o=t.target.result;if(o!==undefined){const t=c.delete(o);t.onsuccess=()=>r(t.result);t.onerror=t=>a(new Error(`Error en la operación ${e}: ${t.target.error}`))}else{a(new Error("Elemento no encontrado para eliminar"))}};n.onerror=e=>a(new Error(`Error al buscar para eliminar: ${e.target.error}`));return}break;default:a(new Error("Operación no válida"));return}l.onsuccess=function(){r(l.result)};l.onerror=function(t){a(new Error(`Error en la operación ${e}: ${t.target.error}`))}};n.onerror=function(e){a(new Error(`Error al abrir la base de datos: ${e.target.error}`))}})},crearElemento:async function(e){try{const t=await manejarCRUD("crear",e);console.log("Elemento creado con éxito:",t)}catch(e){console.error("Error al crear el elemento:",e)}},leerElemento:async function(e,t){try{const o=await manejarCRUD("leer",{[e]:t},e);console.log("Elemento leído:",o)}catch(e){console.error("Error al leer el elemento:",e)}},actualizarElemento:async function(e,t,o){try{const r=await manejarCRUD("leer",{[e]:t},e);if(r){Object.assign(r,o);await manejarCRUD("actualizar",r);console.log("Elemento actualizado con éxito")}else{console.log("Elemento no encontrado")}}catch(e){console.error("Error al actualizar el elemento:",e)}},eliminarElemento:async function(e,t){try{await manejarCRUD("eliminar",{[e]:t},e);console.log("Elemento eliminado con éxito")}catch(e){console.error("Error al eliminar el elemento:",e)}},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(e=>{e.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()},getFormattedDateTime:function(){var e=new Date;var t=String(e.getDate()).padStart(2,"0");var o=String(e.getMonth()+1).padStart(2,"0");var r=String(e.getFullYear());var a=String(e.getHours()).padStart(2,"0");var n=String(e.getMinutes()).padStart(2,"0");var i=String(e.getSeconds()).padStart(2,"0");return t+"/"+o+"/"+r+" "+a+":"+n+":"+i}})});
//# sourceMappingURL=Scan2.controller.js.map