sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(e,t,o,n,r,a){"use strict";var s;var i;var l;var c;var u;var d=[];return e.extend("ventilado.ventilado.controller.Cierre",{onInit:function(){this._dbConnections=[];var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("Log").attachMatched(this.onRouteMatched,this);window.addEventListener("beforeunload",this._handleUnload.bind(this));window.addEventListener("popstate",this._handleUnload.bind(this));this.ejecutarAcciones()},onRouteMatched:function(){this.ejecutarAcciones()},ejecutarAcciones:function(){i=localStorage.getItem("sPuesto");c=localStorage.getItem("sReparto");u=localStorage.getItem("sPtoPlanif");l=localStorage.getItem("sPreparador");this.obtenerYProcesarDatos()},obtenerYProcesarDatos:function(){this.obtenerDatosDeIndexedDB().then(e=>{d=this.procesarDatos(e);const t=d.reduce((e,t)=>e+(t.cantidadAsig||0),0);var n=new o({tableData:d,Transporte:d.length>0?d[0].Transporte:""});this.getView().setModel(n)}).catch(e=>{console.log("Error:",e)})},obtenerDatosDeIndexedDB:async function(){s=this;return new Promise((e,t)=>{let o=indexedDB.open("ventilado",5);o.onerror=e=>{console.log("Error al abrir la base de datos:",e);t("Error al abrir la base de datos")};o.onsuccess=t=>{let o=t.target.result;s._dbConnections.push(o);let n=o.transaction(["ventilado"],"readonly");let r=n.objectStore("ventilado");let a=[];r.openCursor().onsuccess=t=>{let o=t.target.result;if(o){a.push(o.value);o.continue()}else{e(a)}}}})},procesarDatos:function(e){e.sort(function(e,t){if(e.Ruta<t.Ruta){return-1}if(e.Ruta>t.Ruta){return 1}return 0});let t={};e.forEach(e=>{let o=e.LugarPDisp;let n=e.CantidadEntrega;let r=e.M3v;let a=e.Kgbrv;if(!t[o]){t[e.LugarPDisp]={Ruta:o,CLIENTE:e.Destinatario,RAZONSOCIAL:e.NombreDestinatario,ENTREGA:e.Entrega,PRODV:0,KGBrV:0,M3V:0,Transporte:e.Transporte,CubTeo:e.CubTeo,KgBxCub:e.KgBxCub,M3H2O:e.M3teo,porcTeo:0,ProdR:e.ProdR,KGBrR:e.KGBrR,M3R:e.M3R,CubR:e.CubR,PaR:e.PaR,CubEq:e.CubEq,KgbxCubR:e.KgbxCubR,M3H2OR:e.M3H2OR,porcReal:e.porcReal,TOT:0}}t[o]["TOT"]+=n;t[o]["KGBrV"]+=Number(a)||0;t[o]["M3V"]+=Number(r)||0});let o=Object.keys(t).map(e=>t[e]);return o},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(e=>{e.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()}})});
//# sourceMappingURL=Cierre.controller.js.map