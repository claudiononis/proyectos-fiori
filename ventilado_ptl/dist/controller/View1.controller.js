sap.ui.define(["sap/ui/core/UIComponent","sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,o,r,n,s,i){"use strict";var c;var d;var l;var u;var p;var g;return t.extend("ventilado.ventilado.controller.View1",{onInit:function(){this._dbConnections=[];var t=new Date;var a=this._formatDate(t);var o=this.byId("fecha");if(o){o.setValue(a)}g=sessionStorage.getItem("fecha")||(new Date).toISOString().slice(0,10);var r=e.getRouterFor(this);r.getRoute("RouteView1").attachPatternMatched(this.onRouteMatched,this)},onRouteMatched:function(e){console.log("aca")},_formatDate:function(e){var t=String(e.getDate()).padStart(2,"0");var a=String(e.getMonth()+1).padStart(2,"0");var o=e.getFullYear();return t+"/"+a+"/"+o},onScanPress:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Scan")},onDesconsolidadoPress:function(){this.onExit();const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Desconsolidado")},onCierrePress:function(){this.onExit();const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Cierre")},onBuscarPress:function(){l=this.getView().byId("reparto").getValue().padStart(10,"0");u=this.getView().byId("pto_planif").getValue().padStart(4,"0");p=this.getView().byId("puesto").getValue();d=this.getView().byId("Usuario").getValue();localStorage.setItem("sPuesto",p);localStorage.setItem("sReparto",l);localStorage.setItem("sPtoPlanif",u);localStorage.setItem("sPreparador",d);var e=[this.byId("puesto"),this.byId("reparto"),this.byId("pto_planif"),this.byId("Usuario")];var t=true;e.forEach(function(e){if(!e.getValue()){e.setValueState("Error");t=false}else{e.setValueState("None")}});if(t){this.onExit();r.show(0);this.buscarDatos()}else{o.error("ERROR. Por favor, complete todos los campos obligatorios.",{title:"Error ",styleClass:"customMessageBox",onClose:function(){console.log("Mensaje de error personalizado cerrado.")}})}},buscarDatos:function(){var e=this;var t=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZVENTILADO_SRV/",{useBatch:false,defaultBindingMode:"TwoWay",deferredGroups:["batchGroup1"]});t.refreshMetadata();l=e.getView().byId("reparto").getValue().padStart(10,"0");var o=e.getView().byId("Usuario").getValue();var r=e.getView().byId("puesto").getValue();var n=e.getView().byId("pto_planif").getValue();var s=this.getOwnerComponent().getModel("globalModel");if(s){s.setProperty("/puesto",r);s.setProperty("/reparto",l)}t.callFunction("/GenerarTransporte",{method:"GET",urlParameters:{transporte:l,pto_planificacion:n},success:function(t){a.show("Se cargaron los datos para el ventilado");var o=t.Transporte;o=o.padStart(10,"0");var r=t.Entrega;var n=t.Pto_planificacion;var s=t.Ean;console.log("Transporte: ",o);console.log("Pto Entrega: ",n);console.log("Entrega: ",r);console.log("Estado: ",s);e._fetchAndStoreOData()},error:function(e){var t="";try{var o=JSON.parse(e.responseText);t=o.error.message.value}catch(e){t="Error desconocido"}a.show(t)}})},onLogPress:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Log")},onAvancePPress:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Avance")},_fetchAndStoreOData:function(){var e=this;var t=indexedDB.deleteDatabase("ventilado");t.onerror=function(e){console.error("Error al borrar la base de datos:",e.target.errorCode)};t.onblocked=function(e){console.warn("La base de datos no se pudo borrar porque otra conexión aún está abierta.")};t.onsuccess=function(t){console.log("Base de datos borrada con éxito.");var a=indexedDB.open("ventilado",5);a.onerror=function(e){console.error("Error al abrir la base de datos:",e.target.errorCode)};a.onupgradeneeded=function(e){var t=e.target.result;var a=t.createObjectStore("ventilado",{keyPath:"Id"});a.createIndex("Ean","Ean",{unique:false});a.createIndex("Fecha","Fecha",{unique:false});a.createIndex("Transporte","Transporte",{unique:false});a.createIndex("Entrega","Entrega",{unique:false});a.createIndex("NombreDestinatario","NombreDestinatario",{unique:false});a.createIndex("Calle","Calle",{unique:false});a.createIndex("Lugar_destinatario","Lugar_destinatario",{unique:false});a.createIndex("CodigoInterno","CodigoInterno",{unique:false});a.createIndex("Descricion","Descricion",{unique:false});a.createIndex("CantidadEntrega","CantidadEntrega",{unique:false});a.createIndex("LugarPDisp","LugarPDisp",{unique:false});a.createIndex("Preparador","Preparador",{unique:false});a.createIndex("Estado","Estado",{unique:false});a.createIndex("Cubre","Cubre",{unique:false});a.createIndex("Pa","Pa",{unique:false});a.createIndex("AdicChar1","AdicChar1",{unique:false})};a.onsuccess=function(t){e.db=t.target.result;e._dbConnections.push(e.db);console.log("Base de datos abierta con éxito.");var a=new n("/sap/opu/odata/sap/ZVENTILADO_SRV/");var o=[];o.push(new s("Transporte",i.EQ,l));a.read("/ventiladoSet",{filters:o,success:function(t){var a=e.db.transaction(["ventilado"],"readwrite");var o=a.objectStore("ventilado");if(Array.isArray(t.results)){t.results.forEach(function(e){e.Transporte=(e.Transporte||"").padStart(10,"0");o.put(e)})}else{var n=t.results;n.Transporte=(n.Transporte||"").padStart(10,"0");o.put(n)}r.hide();console.log("Datos copiados con éxito.");e.getView().byId("btScan").setEnabled(true);e.getView().byId("btLog").setEnabled(true);e.getView().byId("btAvance").setEnabled(true);e.getView().byId("btCierre").setEnabled(true);e.getView().byId("btDesconsolidado").setEnabled(true)},error:function(e){console.error("Error al leer datos del servicio OData:",e);r.hide()}})}}},onExit:function(){this.closeAllDbConnections()},closeAllDbConnections:function(){this._dbConnections.forEach(e=>{e.close()});this._dbConnections=[]},_handleUnload:function(){this.closeAllDbConnections()}})});
//# sourceMappingURL=View1.controller.js.map